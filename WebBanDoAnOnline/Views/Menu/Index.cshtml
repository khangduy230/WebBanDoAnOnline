@{
    var danhMucList = (List<WebBanDoAnOnline.Models.DanhMuc>)ViewBag.DanhMucList;
    var sanPhamList = (List<WebBanDoAnOnline.Models.SanPham>)ViewBag.SanPhamList;
    int? selectedDmId = (int?)ViewBag.SelectedDMId;
}

<div class="menu-categories-container mb-4">
    <h3 class="mb-3 fw-bold">Danh mục món ăn</h3>
    <div class="menu-categories">
        @foreach (var category in danhMucList)
        {
            bool isSelected = selectedDmId.HasValue
                                ? category.MaDM == selectedDmId.Value
                                : (category.MacDinh == true);

            if (isSelected)
            {
                <a href="@Url.Action("Index", "Menu", new { dmId = category.MaDM })" class="category-item-special">
                    <img src="@Url.Content(category.Anh)" alt="@category.TenDM">
                    <span>@category.TenDM</span>
                </a>
            }
            else
            {
                <a href="@Url.Action("Index", "Menu", new { dmId = category.MaDM })" class="category-item-circle">
                    <div class="category-image">
                        <img src="@Url.Content(category.Anh)" alt="@category.TenDM">
                    </div>
                    <span class="category-name">@category.TenDM</span>
                </a>
            }
        }
    </div>
</div>

<div id="products-container">
    @Html.Partial("_Products") <!-- trang đầu tiên -->
</div>

@section scripts {
    <script>
    // Ajax pagination (progressive enhancement)
    $(function () {
        $('.body-content').on('click', '#products-container .pagination a', function (e) {
            e.preventDefault();

            var href = $(this).attr('href');
            var url = new URL(href, window.location.origin);
            var params = Object.fromEntries(url.searchParams.entries());

            $.get('@Url.Action("Products", "Menu")', params)
                .done(function (html) {
                    $('#products-container').html(html);

                    // Cập nhật URL để hỗ trợ Back/Reload
                    var qs = $.param(params);
                    var newUrl = '@Url.Action("Index", "Menu")' + (qs ? ('?' + qs) : '');
                    window.history.pushState({}, '', newUrl);

                    // Cuộn đến phần danh sách
                    var top = $('#products-container').offset().top - 80;
                    $('html,body').animate({ scrollTop: top }, 200);
                })
                .fail(function () {
                    // Fallback: nếu lỗi Ajax thì chuyển hướng bình thường
                    window.location.href = href;
                });
        });
    });
    </script>
}