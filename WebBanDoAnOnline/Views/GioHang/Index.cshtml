@{
    ViewBag.Title = "Giỏ hàng";
    
}

<script>
    // SỬA 1: Dùng Razor lấy đường dẫn gốc chính xác hơn window.location.origin
    var url_domain = '@Url.Content("~")';
    if (url_domain.endsWith("/")) url_domain = url_domain.slice(0, -1);

    // Hàm format tiền tệ
    function formatMoney(n) {
        return n.toFixed(0).replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.") + " VNĐ";
    }

    // 1. CẬP NHẬT SỐ LƯỢNG (+/-)
    function Update_Qty(id, delta) {
        var formData = new FormData();
        formData.append('id', id);
        formData.append('delta', delta);

        $.ajax({
            type: "POST",
            url: url_domain + '/GioHang/CapNhat_SoLuong',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                LoadDataGioHang(); // Load lại để cập nhật tổng tiền
            },
            error: function (err) {
                alert("Lỗi kết nối server");
            }
        });
    }

    // 2. CẬP NHẬT GHI CHÚ
    function Update_Note(id, input_obj) {
        var content = $(input_obj).val();

        var formData = new FormData();
        formData.append('id', id);
        formData.append('ghichu', content);

        $.ajax({
            type: "POST",
            url: url_domain + '/GioHang/CapNhat_GhiChu',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                console.log("Ghi chú đã lưu");
            }
        });
    }

    // 3. XÓA SẢN PHẨM
    function Del_confirm(id) {
        if (confirm("Xóa món này khỏi giỏ?")) {
            var formData = new FormData();
            formData.append('id', id);

            $.ajax({
                type: "POST",
                url: url_domain + '/GioHang/Xoa_SP_GioHang',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    LoadDataGioHang();
                }
            });
        }
    }
</script>

<section class="container my-4 cart-page">
    <h2 class="fw-bold mb-4">Giỏ hàng</h2>

    <!-- Khu vực hiển thị khi giỏ hàng trống -->
    <div id="empty_cart_msg" class="p-4 bg-white border rounded-3 text-center text-muted" style="display:none;">
        Giỏ hàng của bạn đang trống. <a href="/">Mua sắm ngay</a>
    </div>

    <!-- Khu vực hiển thị dữ liệu giỏ hàng -->
    <div id="cart_content" style="display:none;">
        <!-- Header cột -->
        <div class="row fw-semibold text-muted mb-2 d-none d-md-flex">
            <div class="col-md-6">Sản phẩm</div>
            <div class="col-md-2 text-center">Số lượng</div>
            <div class="col-md-2 text-end">Thành tiền</div>
            <div class="col-md-2 text-center">Thao tác</div>
        </div>

        <!-- Danh sách items -->
        <div class="cart-lines d-flex flex-column gap-3" id="cart_lines_container">
            <!-- Javascript sẽ chèn HTML vào đây -->
        </div>

        <!-- Footer: Tổng tiền và nút bấm -->
        <div class="d-flex flex-column flex-md-row align-items-center justify-content-between mt-4 gap-3 p-3 bg-light rounded">
            <div class="d-flex align-items-center gap-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checkAll" checked>
                    <label class="form-check-label" for="checkAll">Chọn tất cả</label>
                </div>
            </div>

            <div class="d-flex align-items-center gap-3">
                <div class="fw-semibold fs-5">
                    Tổng cộng:
                    <!-- SỬA 2: Đặt ID chính xác để JS cập nhật -->
                    <span id="grandTotal" class="text-danger fw-bold">0 VNĐ</span>
                </div>
                <a href="~/ThanhToan/Index" class="btn btn-warning px-4 py-2 fw-bold">Mua hàng</a>
            </div>
        </div>
    </div>
</section>

<script>
    function LoadDataGioHang() {
        $.ajax({
            type: "POST",
            url: url_domain + '/GioHang/Lay_DSGioHang',
            contentType: false,
            processData: false,
            success: function (response) {
                var data = (typeof response === 'string') ? JSON.parse(response) : response;
                var container = $("#cart_lines_container");

                container.empty();
                var grandTotal = 0;

                if (data.length === 0) {
                    $("#empty_cart_msg").show();
                    $("#cart_content").hide();
                    return;
                } else {
                    $("#empty_cart_msg").hide();
                    $("#cart_content").show();
                }

                var html_str = "";
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    grandTotal += item.ThanhTien;

                    // Xử lý đường dẫn ảnh
                    var img = item.Anh ? item.Anh.replace('~', '') : '';
                    var noteVal = item.GhiChu ? item.GhiChu : "";

                    html_str += `
                    <div class="cart-line p-3 border rounded-3 bg-white mb-3 shadow-sm">
                        <div class="row g-3 align-items-center">

                            <!-- Cột 1: Checkbox + Ảnh + Tên -->
                            <div class="col-md-6 d-flex align-items-center gap-3">
                                <input type="checkbox" class="form-check-input" checked />

                                <!-- SỬA 3: Thêm onerror để xử lý ảnh bị lỗi 404 -->
                                <img src="${img}"
                                     style="width:60px; height:60px; object-fit:cover; border-radius:8px"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/60?text=No+Img';"
                                />

                                <div style="flex:1">
                                    <div class="fw-bold text-dark">${item.TenSP}</div>
                                    <div class="small text-muted">
                                        Đơn giá: ${formatMoney(item.GiaHienTai)}
                                    </div>
                                    <input type="text" class="form-control form-control-sm mt-2"
                                           placeholder="Ghi chú món ăn..."
                                           value="${noteVal}"
                                           onblur="Update_Note(${item.MaSP}, this)" />
                                </div>
                            </div>

                            <!-- Cột 2: Số lượng -->
                            <div class="col-md-2 text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="Update_Qty(${item.MaSP}, -1)">-</button>
                                    <button type="button" class="btn btn-light" disabled style="width:35px; font-weight:bold; color:#000">${item.SoLuong}</button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="Update_Qty(${item.MaSP}, 1)">+</button>
                                </div>
                            </div>

                            <!-- Cột 3: Thành tiền -->
                            <div class="col-md-2 text-end fw-bold text-danger">
                                ${formatMoney(item.ThanhTien)}
                            </div>

                            <!-- Cột 4: Xóa -->
                            <div class="col-md-2 text-center">
                                <button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="Del_confirm(${item.MaSP})" title="Xóa">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
                }

                container.html(html_str);

                // Cập nhật tổng tiền (Đã sửa ID khớp với HTML)
                $("#grandTotal").text(formatMoney(grandTotal));
            },
            error: function (err) {
                console.log("Lỗi tải giỏ hàng:", err);
            }
        });
    }

    $(document).ready(function () {
        LoadDataGioHang();
    });
</script>