@{
    ViewBag.Title = "Thanh toán";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .address-card {
        cursor: pointer;
        border: 2px solid #eee;
        padding: 15px;
        border-radius: 8px;
        transition: 0.2s;
        width: 100%;
        position: relative;
    }

        .address-card:hover {
            border-color: #ffc107;
        }

        .address-card.active {
            border-color: #ffc107;
            background-color: #fffcf5;
        }

            .address-card.active::after {
                content: '\f00c';
                font-family: "Font Awesome 6 Free";
                font-weight: 900;
                position: absolute;
                top: 10px;
                right: 10px;
                color: #ffc107;
            }

    .btn-pay {
        min-width: 120px;
    }

        .btn-pay.active {
            background-color: #ffc107;
            color: white;
            border-color: #ffc107;
        }
</style>

<div class="checkout-page container my-4">
    <h2 class="fw-bold mb-3">Thanh toán</h2>

    <!-- Loading Spinner -->
    <div id="loading-checkout" class="text-center py-5">
        <div class="spinner-border text-warning"></div>
        <div class="mt-2">Đang tải thông tin...</div>
    </div>

    <!-- Nội dung chính (Ẩn lúc đầu) -->
    <div id="checkout-content" class="row g-4" style="display:none">
        <!-- CỘT TRÁI -->
        <div class="col-lg-8">

            <!-- 1. ĐỊA CHỈ GIAO HÀNG -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold m-0"><i class="fa-solid fa-location-dot text-warning me-2"></i>Địa chỉ nhận hàng</h5>
                        <a href="/TaiKhoan/DiaChi" class="small text-decoration-none">Quản lý địa chỉ</a>
                    </div>

                    <div id="list-address" class="d-flex flex-column gap-2">
                        <!-- JS Render địa chỉ vào đây -->
                    </div>
                </div>
            </div>

            <!-- 2. PHƯƠNG THỨC THANH TOÁN -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="fw-bold mb-3"><i class="fa-solid fa-wallet text-warning me-2"></i>Phương thức thanh toán</h5>
                    <div class="d-flex gap-3 pay-method">
                        <button type="button" class="btn btn-outline-warning btn-pay active" onclick="ChonPhuongThuc('COD', this)">
                            <i class="fa-solid fa-money-bill-1-wave me-2"></i>Tiền mặt
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-pay" onclick="ChonPhuongThuc('BANK', this)">
                            <i class="fa-solid fa-building-columns me-2"></i>Ngân hàng
                        </button>
                    </div>
                </div>
            </div>

            <!-- 3. VOUCHER -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="fw-bold mb-3"><i class="fa-solid fa-ticket text-warning me-2"></i>Voucher giảm giá</h5>

                    <!-- Ô nhập thủ công -->
                    <div class="d-flex mb-3" style="max-width:100%;">
                        <input id="voucher-input" class="form-control" placeholder="Nhập mã giảm giá" />
                        <button class="btn btn-warning ms-2 text-white fw-bold" onclick="ApDungVoucher()">Áp dụng</button>
                    </div>
                    <div id="voucher-msg" class="small mb-3"></div>

                    <!-- DANH SÁCH VOUCHER HIỆN TRỰC TIẾP Ở ĐÂY -->
                    <div class="fw-bold small text-muted mb-2">Hoặc chọn mã có sẵn:</div>
                    <div id="list-voucher-inline" class="d-flex flex-column gap-2" style="max-height: 300px; overflow-y: auto;">
                        <!-- Javascript sẽ điền danh sách voucher vào đây -->
                    </div>
                </div>
            </div>

            <!-- 4. GHI CHÚ -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="fw-bold mb-3"><i class="fa-regular fa-pen-to-square text-warning me-2"></i>Ghi chú đơn hàng</h5>
                    <textarea id="note-input" class="form-control" rows="3" placeholder="Ví dụ: Không cay, nhiều tương ớt..."></textarea>
                </div>
            </div>
        </div>

        <!-- CỘT PHẢI (Tổng kết) -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3 border-bottom pb-2">
                        <h5 class="fw-bold">Đơn hàng</h5>
                        <div class="text-muted small"><span id="count-items">0</span> món</div>
                    </div>

                    <!-- Danh sách món (rút gọn) -->
                    <div id="checkout-lines" class="d-flex flex-column gap-3 mb-3" style="max-height:300px; overflow-y:auto">
                        <!-- JS Render sản phẩm -->
                    </div>

                    <hr />
                    <!-- Tổng tiền -->
                    <div class="small text-muted mb-1">Chi tiết thanh toán</div>
                    <div class="d-flex justify-content-between small mb-1">
                        <span>Tổng tiền hàng</span>
                        <span id="lbl-subtotal">0đ</span>
                    </div>
                    <div class="d-flex justify-content-between small mb-1">
                        <span>Phí vận chuyển</span>
                        <span id="lbl-shipping">0đ</span>
                    </div>
                    <div class="d-flex justify-content-between small text-success mb-2">
                        <span>Giảm giá</span>
                        <span id="lbl-discount">0đ</span>
                    </div>

                    <div class="border-top pt-2 mt-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="fw-bold">Tổng thanh toán</div>
                            <div id="lbl-total" class="fw-bold text-warning fs-5">0đ</div>
                        </div>
                    </div>

                    <button id="btn-place-order" class="btn btn-warning w-100 mt-3 fw-bold text-white" onclick="DatHang()">
                        ĐẶT HÀNG
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Cấu hình đường dẫn gốc
    var url_domain = '@Url.Content("~")';
    if (url_domain.endsWith("/")) url_domain = url_domain.slice(0, -1);

    // 2. Biến toàn cục lưu trạng thái đơn hàng
    var currentPayMethod = "COD";
    var selectedAddressId = 0;

    var subTotal = 0;    // Tổng tiền hàng
    var shippingFee = 0; // Phí ship
    var discount = 0;    // Giảm giá

    var voucherCodeApplied = ""; // Mã đang áp dụng

    // Hàm định dạng tiền tệ (VD: 100000 -> 100.000đ)
    function formatMoney(n) {
        return n.toFixed(0).replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.") + "đ";
    }

    // ================================================================
    // 3. LOAD DỮ LIỆU KHI VÀO TRANG
    // ================================================================
    $(document).ready(function () {
        LoadThongTinThanhToan();
    });

    function LoadThongTinThanhToan() {
        $.ajax({
            type: "POST",
            url: url_domain + '/ThanhToan/LayThongTinThanhToan',
            contentType: false, processData: false, cache: false,
            success: function (response) {
                if (response === "LOGIN_REQUIRED") {
                    window.location.href = "/TaiKhoan/Login";
                    return;
                }

                var data = JSON.parse(response);
                console.log(data);

                // --- A. CẬP NHẬT BIẾN TOÀN CỤC TRƯỚC ---
                subTotal = data.TongTienHang;
                shippingFee = data.PhiShip;
                discount = 0;
                voucherCodeApplied = "";

                // --- B. RENDER ĐỊA CHỈ ---
                var addrContainer = $("#list-address");
                var htmlAddr = "";
                if (data.DiaChi.length === 0) {
                    htmlAddr = `<div class="alert alert-warning mb-0">Bạn chưa có địa chỉ. <a href="/TaiKhoan/DiaChi" class="fw-bold">Thêm ngay</a></div>`;
                } else {
                    for (var i = 0; i < data.DiaChi.length; i++) {
                        var addr = data.DiaChi[i];
                        var isActive = (i === 0) ? "active" : "";
                        if (i === 0) selectedAddressId = addr.MaDiaChi;

                        htmlAddr += `
                        <div class="address-card ${isActive}" onclick="ChonDiaChi(${addr.MaDiaChi}, this)">
                            <div class="fw-bold">${addr.TenNguoiNhan} (${addr.SDTNhan})</div>
                            <div class="text-muted small">${addr.DiaChiCuThe}</div>
                            ${addr.MacDinh ? '<span class="badge bg-light text-dark border mt-1">Mặc định</span>' : ''}
                        </div>`;
                    }
                }
                addrContainer.html(htmlAddr);

                // --- C. RENDER GIỎ HÀNG ---
                var cartContainer = $("#checkout-lines");
                var htmlCart = "";
                for (var i = 0; i < data.SanPham.length; i++) {
                    var item = data.SanPham[i];
                    htmlCart += `
                    <div class="d-flex justify-content-between align-items-start border-bottom pb-2">
                        <div>
                            <div class="fw-bold small text-truncate" style="max-width:200px">${item.TenSP}</div>
                            <div class="text-muted" style="font-size:11px">SL: ${item.SoLuong} x ${formatMoney(item.DonGia)}</div>
                        </div>
                        <div class="fw-bold small text-end">${formatMoney(item.ThanhTien)}</div>
                    </div>`;
                }
                cartContainer.html(htmlCart);
                $("#count-items").text(data.SanPham.length);

                // --- D. RENDER DANH SÁCH VOUCHER (INLINE) ---
                var voucherContainer = $("#list-voucher-inline");
                var htmlVoucher = "";

                if (!data.DanhSachVoucher || data.DanhSachVoucher.length === 0) {
                    htmlVoucher = '<div class="text-muted small fst-italic py-2">Hiện không có mã giảm giá nào.</div>';
                } else {
                    for (var i = 0; i < data.DanhSachVoucher.length; i++) {
                        var v = data.DanhSachVoucher[i];

                        // Điều kiện: Tổng tiền hàng >= Điều kiện tối thiểu của voucher
                        var minBill = v.DieuKienToiThieu || 0;
                        var duDieuKien = subTotal >= minBill;

                        // CSS và Trạng thái
                        var disabledClass = duDieuKien ? "" : "opacity-50 bg-light";
                        var clickAction = duDieuKien ? `onclick="ChonVoucherTrucTiep('${v.MaCode}', this)"` : "";
                        var cursorStyle = duDieuKien ? "cursor:pointer" : "cursor:not-allowed";
                        var badgeInfo = duDieuKien ? '<span class="badge bg-success">Dùng được</span>' : '<span class="badge bg-secondary">Chưa đủ ĐK</span>';

                        // Hiển thị số tiền giảm
                        var textGiam = v.LoaiGiam === "Tiền" ? formatMoney(v.GiaTri) : v.GiaTri + "%";

                        htmlVoucher += `
                        <div class="border rounded p-2 mb-2 position-relative voucher-item ${disabledClass}"
                             style="${cursorStyle}" ${clickAction}>

                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <input type="radio" name="voucherGroup" class="form-check-input" ${duDieuKien ? "" : "disabled"}>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold text-danger">${v.MaCode}</span>
                                        ${badgeInfo}
                                    </div>
                                    <div class="small fw-bold">Giảm ${textGiam}</div>
                                    <div class="text-muted" style="font-size:11px">Đơn tối thiểu ${formatMoney(minBill)}</div>
                                </div>
                            </div>
                        </div>`;
                    }
                }
                voucherContainer.html(htmlVoucher);

                // --- E. CẬP NHẬT UI TỔNG TIỀN ---
                UpdateTotalUI();

                // Hiển thị nội dung, ẩn loading
                $("#loading-checkout").hide();
                $("#checkout-content").show();
            },
            error: function (err) {
                alert("Lỗi tải dữ liệu thanh toán.");
                console.log(err);
            }
        });
    }

    // ================================================================
    // 4. CÁC HÀM XỬ LÝ UI
    // ================================================================

    // Cập nhật các con số trên giao diện
    function UpdateTotalUI() {
        $("#lbl-subtotal").text(formatMoney(subTotal));
        $("#lbl-shipping").text(formatMoney(shippingFee));
        $("#lbl-discount").text("-" + formatMoney(discount));
        $("#lbl-total").text(formatMoney(subTotal + shippingFee - discount));
    }

    // Chọn địa chỉ giao hàng
    function ChonDiaChi(id, el) {
        selectedAddressId = id;
        $(".address-card").removeClass("active");
        $(el).addClass("active");
    }

    // Chọn phương thức thanh toán (COD / BANK)
    function ChonPhuongThuc(method, el) {
        currentPayMethod = method;
        $(".btn-pay").removeClass("active");
        $(el).addClass("active");

        if(method === "BANK") {
            alert("Thanh toán Ngân hàng đang bảo trì. Vui lòng chọn Tiền mặt.");
            ChonPhuongThuc('COD', $(".btn-pay").first());
        }
    }

    // ================================================================
    // 5. XỬ LÝ VOUCHER
    // ================================================================

    // Khi người dùng click vào Voucher trong danh sách
    function ChonVoucherTrucTiep(code, el) {
        // Đánh dấu radio button
        $(el).find("input[type='radio']").prop("checked", true);
        // Điền mã vào ô input
        $("#voucher-input").val(code);
        // Gọi hàm áp dụng
        ApDungVoucher();
    }

    // Gọi API kiểm tra mã Voucher
    function ApDungVoucher() {
        var code = $("#voucher-input").val();
        if(!code) { alert("Vui lòng nhập mã"); return; }

        var formData = new FormData();
        formData.append('code', code);
        formData.append('total', subTotal); // Gửi tổng tiền hàng để server check

        $.ajax({
            type: "POST",
            url: url_domain + '/ThanhToan/KiemTraVoucher',
            data: formData,
            contentType: false, processData: false, cache: false,
            success: function (response) {
                var data = JSON.parse(response);
                var msgDiv = $("#voucher-msg");

                if (data.ok) {
                    discount = data.discount;
                    voucherCodeApplied = code;
                    msgDiv.html('<i class="fa-solid fa-check-circle"></i> ' + data.msg + " (Giảm " + formatMoney(discount) + ")")
                          .removeClass("text-danger").addClass("text-success");
                } else {
                    discount = 0;
                    voucherCodeApplied = "";
                    // Bỏ tích radio nếu lỗi
                    $("input[name='voucherGroup']").prop("checked", false);
                    msgDiv.html('<i class="fa-solid fa-circle-exclamation"></i> ' + data.msg)
                          .removeClass("text-success").addClass("text-danger");
                }
                UpdateTotalUI();
            },
            error: function(err) {
                console.log(err);
            }
        });
    }

    // ================================================================
    // 6. XỬ LÝ ĐẶT HÀNG
    // ================================================================
    function DatHang() {
        if (selectedAddressId === 0) {
            alert("Vui lòng chọn địa chỉ giao hàng.");
            return;
        }

        // Disable nút đặt hàng để tránh click đúp
        var btn = $("#btn-place-order");
        btn.prop("disabled", true).text("ĐANG XỬ LÝ...");

        var note = $("#note-input").val();

        var formData = new FormData();
        formData.append('addressId', selectedAddressId);
        formData.append('payMethod', currentPayMethod);
        formData.append('note', note);
        formData.append('voucherCode', voucherCodeApplied);

        $.ajax({
            type: "POST",
            url: url_domain + '/ThanhToan/DatHang',
            data: formData,
            contentType: false, processData: false, cache: false,
            success: function (response) {
                if (response === "SUCCESS") {
                    alert("🎉 Đặt hàng thành công!");
                    window.location.href = "/ThanhToan/Success";
                } else if (response === "LOGIN_REQUIRED") {
                    window.location.href = "/TaiKhoan/Login";
                } else {
                    alert("⚠️ " + response);
                    btn.prop("disabled", false).text("ĐẶT HÀNG");
                }
            },
            error: function (err) {
                alert("Lỗi kết nối server. Vui lòng thử lại.");
                btn.prop("disabled", false).text("ĐẶT HÀNG");
            }
        });
    }
</script>